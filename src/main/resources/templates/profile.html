<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile</title>
    <link rel="stylesheet" href="/front/style.css">
</head>
<body>
<main class="auth-shell profile-shell">
    <div class="auth-bg" aria-hidden="true"></div>

    <section class="auth-box auth-card profile-card" aria-label="Profile">
        <header class="auth-header">
            <div class="auth-mark" aria-hidden="true"></div>
            <h1 class="auth-title">Profile</h1>
            <p class="auth-subtitle">Manage your account settings</p>
        </header>

        <div class="message is-success" th:if="${updated}" role="status" aria-live="polite">
            &#10003; Changes saved successfully
        </div>
        <div class="message is-success" th:if="${revoked}" role="status" aria-live="polite">
            &#10003; All sessions revoked
        </div>

        <form class="auth-form" action="/profile" method="post"
              th:object="${profile}" novalidate>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="field">
                <label class="field-label" for="profile_username">Username</label>
                <input id="profile_username" type="text" th:field="*{username}"
                       class="auth-input" th:classappend="${#fields.hasErrors('username')} ? ' is-error'"
                       autocomplete="username" required minlength="3" maxlength="32">
                <div class="field-hint is-error" th:if="${#fields.hasErrors('username')}"
                     th:errors="*{username}" aria-live="polite"></div>
            </div>

            <div class="field">
                <label class="field-label" for="profile_email">
                    Email
                    <span class="verified-badge" th:if="${emailVerified}">&#10003; Verified</span>
                    <span class="unverified-badge" th:if="${!emailVerified}">&#9888; Not verified</span>
                </label>
                <input id="profile_email" type="email" th:field="*{email}"
                       class="auth-input" th:classappend="${#fields.hasErrors('email')} ? ' is-error'"
                       autocomplete="email" required>
                <div class="field-hint is-error" th:if="${#fields.hasErrors('email')}"
                     th:errors="*{email}" aria-live="polite"></div>
                <div class="field-hint" th:if="${!emailVerified}">
                    <a href="#" id="sendConfirmLink" class="field-link">Send confirmation email</a>
                </div>
            </div>

            <section class="mfa-card" aria-label="Multi-factor authentication">
                <div class="mfa-head">
                    <div>
                        <h2 class="mfa-title">Multi-factor authentication</h2>
                        <p class="mfa-subtitle" th:if="${profile.mfaEnabled}">MFA is active on your account.</p>
                        <p class="mfa-subtitle" th:if="${!profile.mfaEnabled}">Enable MFA to secure your account with one-time codes.</p>
                    </div>
                    <label class="toggle" for="profile_mfa">
                        <input type="checkbox" th:field="*{mfaEnabled}" id="profile_mfa">
                        <span class="toggle-ui" aria-hidden="true"></span>
                        <span class="toggle-label">Enable MFA</span>
                    </label>
                </div>
                <div class="mfa-body" th:if="${!profile.mfaEnabled}">
                    <p class="mfa-note">
                        After enabling MFA, go to
                        <a href="/user-info/mfa/setup" class="field-link">MFA Setup</a>
                        to configure your authenticator app.
                    </p>
                </div>
            </section>

            <button type="submit" class="auth-button" data-submit>
                <span class="btn-label">Save changes</span>
                <span class="btn-spinner" aria-hidden="true"></span>
            </button>
        </form>

        <section class="history" aria-label="Login history">
            <h2 class="section-title">Last 10 logins</h2>
            <div class="table-wrap" role="region" aria-label="Login history table" tabindex="0">
                <table class="table">
                    <thead>
                    <tr>
                        <th>Time</th>
                        <th>IP</th>
                        <th>Location</th>
                        <th>Device</th>
                        <th>Method</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="h : ${loginHistory}">
                        <td th:text="${#temporals.format(h.timestamp, 'yyyy-MM-dd HH:mm')}"></td>
                        <td th:text="${h.ipAddress}"></td>
                        <td th:text="${h.location}"></td>
                        <td class="ua-cell" th:text="${h.userAgent}"></td>
                        <td th:text="${h.loginMethod}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(loginHistory)}">
                        <td colspan="5" style="color:var(--muted);text-align:center">No login events yet.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="danger" aria-label="Danger zone">
            <h2 class="section-title">Danger zone</h2>
            <p class="danger-text">
                Revoke all active sessions across all devices. This rotates your security stamp
                and invalidates all refresh tokens immediately.
            </p>
            <form action="/profile/revoke" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="danger-button">Revoke All Sessions</button>
            </form>
        </section>

        <nav class="auth-links profile-nav" aria-label="Profile links">
            <a href="/">Home</a>
            <form action="/spa/logout" method="post" style="display:inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="link-btn-plain">Logout</button>
            </form>
        </nav>
    </section>
</main>

<script defer src="/front/script.js"></script>
</body>
</html>